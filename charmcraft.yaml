type: charm

parts:
  deadsnakes:
    plugin: nil
    override-build: |
      apt-get update -q
      apt-get install -y software-properties-common
      add-apt-repository -y ppa:deadsnakes/ppa
      apt install -y python3.11 python3.11-dev python3.11-venv
      update-alternatives --force --install /usr/bin/python3 python3 /usr/bin/python3.10 1
      update-alternatives --force --install /usr/bin/python3 python3 /usr/bin/python3.11 2
      ls -l /usr/bin/python3
      python3 --version
      env
  charm:
    after: [deadsnakes]
    source: src/
    plugin: reactive
    reactive-charm-build-arguments:
      - --binary-wheels-from-source
      - -v
    build-packages:
      - git
      - python3-dev
      - libffi-dev
      - libssl-dev
      - rustc
      - cargo
    build-snaps:
      - charm
    build-environment:
      - CHARM_INTERFACES_DIR: /root/project/interfaces/
      - CHARM_LAYERS_DIR: /root/project/layers/
      - MAKEFLAGS: -j$(nproc)

bases:
  - build-on:
      - name: ubuntu
        channel: "22.04"
        architectures: [amd64]
    run-on:
      - name: ubuntu
        channel: "23.04"
        architectures: [amd64]
